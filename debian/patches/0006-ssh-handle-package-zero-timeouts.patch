--- a/src/channels.c
+++ b/src/channels.c
@@ -1769,7 +1769,11 @@
 
   for (t = timeout_ms; t >= 0; t -= 50)
   {
-    ssh_handle_packets(session, 50);
+    if (timeout_ms == 0) {
+        ssh_handle_packets(session, 0);
+    } else {
+        ssh_handle_packets(session, 50);
+    }
 
     if (session->ssh_message_list) {
       iterator = ssh_list_get_iterator(session->ssh_message_list);
